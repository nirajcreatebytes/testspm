
name: Swift
on:
  push:
    branches: ['testxc']
#      tags:  
#        - '*'
jobs:
  build:
    permissions: write-all    
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v3
#     - name: Build
#       run: swift build -v
#     - name: Run tests
#       run: swift test -v
#     - name: Generate Release
#       id: create_release
#       uses: actions/create-release@v1
#       env:
#         GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
#       with:
#         tag_name: ${{ github.ref_name }}
#         release_name: ${{ github.ref_name }}
#         draft: false
#         prerelease: false

    - name: Setup Xcode 14
      run: sudo xcode-select -switch /Applications/Xcode_14.1.app
    - name: ghr
      run: brew install ghr
    - name: ios build
      id: ios_build
      run: xcodebuild archive -project "testxc/testxc.xcodeproj" -scheme testxc -sdk iphoneos -archivePath "archives/ios_devices.xcarchive" BUILD_LIBRARY_FOR_DISTRIBUTION=YES SKIP_INSTALL=NO
    - name: Build
      id: simulator
      run: xcodebuild archive -project "testxc/testxc.xcodeproj" -scheme testxc -sdk iphonesimulator -archivePath "archives/ios_simulators.xcarchive" BUILD_LIBRARY_FOR_DISTRIBUTION=YES SKIP_INSTALL=NO
    - name: Build app
      id: final_build
      run: |
        xcodebuild -create-xcframework -framework archives/ios_devices.xcarchive/Products/Library/Frameworks/testxc.framework -framework archives/ios_simulators.xcarchive/Products/Library/Frameworks/testxc.framework -output build/testxc.xcframework

    - name: Create zip
      run: |
       zip -r anubhav.xcframework.zip build/testxc.xcframework/*
    - name: Upload to JFrog
      env:
        artifactory_username: ${{ secrets.JF_USER }}
        artifactory_password: ${{ secrets.JF_PASSWORD }}
        artifactory_host: ${{ secrets.JF_URL }}
      run: |
        echo $artifactory_host
        curl -X PUT -u${artifactory_username}:${artifactory_password} -H "Accept: application/vnd.swift.registry.v1+json" -F source-archive="@anubhav.xcframework.zip" https://createbytes.jfrog.io/artifactory/api/swift/swift/anubhav/anubhav.zip
 
